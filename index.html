<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpinionOrbit ‚Äî —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏–∑ –±–∞–∑—ã</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f0f2f5; min-height: 100vh; }
    header { background: #0d47a1; color: white; padding: 1rem; text-align: center; position: relative; }
    .container { display: flex; gap: 1rem; padding: 1rem; max-width: 1700px; margin: 0 auto; }
    aside, main { background: white; border-radius: 4px; box-shadow: 0 2px 20px rgba(0,0,0,0.08); padding: 1rem; }
    aside { width: 380px; overflow-y: auto; }
    main { flex: 1; }
    #status { position: fixed; top: 10px; right: 10px; padding: 6px 12px; border-radius: 4px; color: white; font-weight: 600; z-index: 1000; }
    .card {
      margin-bottom: 0.7rem;
      padding: 0.9rem;
      border-radius: 4px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.06);
      transition: transform 0.3s, opacity 0.5s;
      opacity: 0;
      animation: fadeIn 0.6s forwards;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    .card:hover { transform: translateY(-4px); }
    .text {
      margin-bottom: 0.5rem;
      line-height: 1.4;
      transition: font-size 0.4s ease, font-weight 0.4s ease;
    }
    .reactions { display: flex; gap: 3px; flex-wrap: nowrap; overflow-x: auto; padding: 4px 0; }
    .reaction-btn {
      display: flex; align-items: center; gap: 4px; padding: 3px 6px; border-radius: 4px;
      background: #f1f3f5; border: 1px solid #dee2e6; cursor: pointer; transition: all 0.15s;
      font-size: 0.95rem; white-space: nowrap;
    }
    .reaction-btn:hover { background: #e9ecef; transform: scale(1.08); }
    .reaction-btn.active {
      background: #e3f2fd;
      border-color: #90caf9;
      box-shadow: 0 0 0 3px rgba(144,202,249,0.3);
    }
    .emoji { font-size: 1.3rem; }
    .count { font-weight: 600; min-width: 20px; text-align: center; font-size: 0.9rem; animation: pulse 0.6s ease-out; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.5); } 100% { transform: scale(1); } }
    .sort-select { 
      padding: 0.6rem; 
      border-radius: 4px; 
      border: 1px solid #ced4da; 
      margin-bottom: 1rem; 
      width: 100%; 
      font-size: 0.95rem;
    }
    input, button { padding: 0.8rem; border-radius: 4px; width: 100%; margin-bottom: 0.8rem; box-sizing: border-box; }
    button { background: #1976d2; color: white; border: none; cursor: pointer; }
    button:hover { background: #1565c0; }
  </style>
</head>
<body>
<div id="status" style="background:#28a745;">Realtime –ø–æ–¥–∫–ª—é—á—ë–Ω!</div>
<header>
  <h2>–¢–µ–º–∞: –ë—É–¥—É—â–µ–µ –ò–ò –≤ –æ–±—â–µ—Å—Ç–≤–µ</h2>
</header>
<div class="container">
  <aside>
    <h3>–í—Å–µ —Ç–µ–∑–∏—Å—ã (–∫—Ä–æ–º–µ –º–æ–∏—Ö –∏ –≤ —Ü–µ–Ω—Ç—Ä–µ)</h3>
    <select id="left-sort" class="sort-select" onchange="updateLeftSort()">
      <option value="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–æ–∫...</option>
    </select>
    <div id="left-list"></div>
  </aside>

  <main id="center-board">
    <h3>–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å (—Ç–æ–ø-—Ä–µ–∞–∫—Ü–∏–∏)</h3>
    <div id="center-content"></div>
  </main>

  <aside>
    <h3>–ú–æ–∏ —Ç–µ–∑–∏—Å—ã</h3>
    <select id="right-sort" class="sort-select" onchange="updateRightSort()">
      <option value="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–æ–∫...</option>
    </select>
    <input id="new-input" placeholder="–ù–æ–≤—ã–π —Ç–µ–∑–∏—Å...">
    <button onclick="addThesis()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    <div id="my-theses"></div>
  </aside>
</div>

<script>
// Supabase
const SUPABASE_URL = 'https://lhdayvfykjvgfhwhsixz.supabase.co';
const SUPABASE_KEY = 'sb_publishable_d6BZCtGvL9ukuGAa9PCHGQ_wAkfUhJb';

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// –¢–æ–∫–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
const userToken = localStorage.getItem('user_token') || crypto.randomUUID();
localStorage.setItem('user_token', userToken);

// –ü–æ—Ä–æ–≥ –ø–µ—Ä–µ–Ω–æ—Å–∞ (–∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ settings)
let TRANSFER_THRESHOLD = 3;
async function loadThreshold() {
  const { data } = await sb.from('settings').select('value').eq('key', 'top_count').single();
  if (data) TRANSFER_THRESHOLD = data.value;
  console.log("–ü–æ—Ä–æ–≥ –ø–µ—Ä–µ–Ω–æ—Å–∞:", TRANSFER_THRESHOLD);
}

// –†–µ–∞–∫—Ü–∏–∏
const reactions = [
  { value: -2, emoji: 'üò°', label: '–æ—Ç—Å—Ç–æ–π', color: '#c62828', countField: 'count_minus2' },
  { value: -1, emoji: 'üòí', label: '–µ—Ä—É–Ω–¥–∞', color: '#ef5350', countField: 'count_minus1' },
  { value: 0, emoji: 'ü§î', label: '–Ω–µ–ø–æ–Ω—è—Ç–Ω–æ', color: '#757575', countField: 'count_zero' },
  { value: 1, emoji: 'üëç', label: '–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ', color: '#66bb6a', countField: 'count_plus1' },
  { value: 2, emoji: 'üî•', label: '—Å—Ç–æ –ø—É–¥–æ–≤–æ!', color: '#2e7d32', countField: 'count_plus2' }
];

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–µ–∑–∏—Å–∞ (—Ç–æ–ª—å–∫–æ –≤ –º–æ–∏ —Ç–µ–∑–∏—Å—ã)
async function addThesis() {
  const text = document.getElementById('new-input').value.trim();
  if (!text) return;

  const { error } = await sb.from('theses').insert({
    text,
    user_token: userToken,
    score: 0,
    count_minus2: 0,
    count_minus1: 0,
    count_zero: 0,
    count_plus1: 0,
    count_plus2: 0,
    is_central: false
  });

  if (error) {
    alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: ' + error.message);
  } else {
    document.getElementById('new-input').value = '';
    loadMyTheses();
  }
}

// –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –º–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function vote(thesisId, value) {
  await sb.from('votes')
    .delete()
    .eq('thesis_id', thesisId)
    .eq('user_token', userToken);

  const { error } = await sb.from('votes').insert({
    thesis_id: thesisId,
    user_token: userToken,
    value: value
  });

  if (error) {
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å');
    return;
  }

  await recalculateThesis(thesisId);
  await checkAndTransferToCenter(thesisId);

  const reactionsDiv = document.querySelector(`.reactions[data-thesis-id="${thesisId}"]`);
  if (reactionsDiv) {
    reactionsDiv.querySelectorAll('.reaction-btn').forEach(btn => btn.classList.remove('active'));
    const activeBtn = reactionsDiv.querySelector(`[data-value="${value}"]`);
    if (activeBtn) activeBtn.classList.add('active');
  }

  loadAllTheses();
  loadMyTheses();
  loadCenter();
}

// –ü–µ—Ä–µ—Å—á—ë—Ç —Å—á—ë—Ç—á–∏–∫–æ–≤ –∏ score
async function recalculateThesis(thesisId) {
  const { data: votes } = await sb.from('votes').select('value').eq('thesis_id', thesisId);
  const counts = { count_minus2: 0, count_minus1: 0, count_zero: 0, count_plus1: 0, count_plus2: 0 };
  let sum = 0;

  votes.forEach(v => {
    sum += v.value;
    if (v.value === -2) counts.count_minus2++;
    if (v.value === -1) counts.count_minus1++;
    if (v.value === 0) counts.count_zero++;
    if (v.value === 1) counts.count_plus1++;
    if (v.value === 2) counts.count_plus2++;
  });

  const averageScore = votes.length ? sum / votes.length : 0;

  const { error } = await sb.from('theses').update({
    score: averageScore,
    ...counts
  }).eq('id', thesisId);

  if (error) console.error("–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—á—ë—Ç–∞:", error.message);
  else console.log("–°—á—ë—Ç—á–∏–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!");
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø–µ—Ä–µ–Ω–æ—Å –≤ —Ü–µ–Ω—Ç—Ä
async function checkAndTransferToCenter(thesisId) {
  const { data: thesis } = await sb.from('theses').select('*').eq('id', thesisId).single();
  if (!thesis || thesis.is_central) return;

  let shouldTransfer = false;
  for (const r of reactions) {
    if (thesis[r.countField] >= TRANSFER_THRESHOLD) {
      shouldTransfer = true;
      break;
    }
  }

  if (shouldTransfer) {
    console.log("–ü–µ—Ä–µ–Ω–æ—Å –≤ —Ü–µ–Ω—Ç—Ä! –†–µ–∞–∫—Ü–∏—è ‚â•", TRANSFER_THRESHOLD);
    await sb.from('theses').update({ is_central: true }).eq('id', thesisId);
    loadAllTheses();
    loadMyTheses();
    loadCenter();
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Ç–µ–∑–∏—Å–æ–≤ (–ª–µ–≤–∞—è –ø–∞–Ω–µ–ª—å ‚Äî –∫—Ä–æ–º–µ –º–æ–∏—Ö –∏ —É–∂–µ –≤ —Ü–µ–Ω—Ç—Ä–µ)
async function loadAllTheses() {
  const sort = localStorage.getItem('left_sort') || 'created_at_desc';

  const { data: sortOpt } = await sb.from('sort_options').select('order_by, order_dir').eq('sort_key', sort).single();
  const orderBy = sortOpt ? sortOpt.order_by : 'created_at';
  const orderDir = sortOpt ? sortOpt.order_dir : 'desc';

  const { data } = await sb.from('theses')
    .select('*')
    .neq('user_token', userToken)
    .eq('is_central', false)
    .order(orderBy, { ascending: orderDir === 'asc' });

  const container = document.getElementById('left-list');
  container.innerHTML = '';

  data.forEach(item => {
    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.thesisId = item.id;
    card.style.background = getColorByScore(item.score || 0);
    card.innerHTML = `
      <div class="text">${item.text}</div>
      <div class="reactions" data-thesis-id="${item.id}">
        ${reactions.map(r => `
          <div class="reaction-btn" data-value="${r.value}" onclick="vote('${item.id}', ${r.value})">
            <span class="emoji">${r.emoji}</span>
            <span class="count">${item[r.countField] || 0}</span>
          </div>
        `).join('')}
      </div>
    `;
    container.appendChild(card);
  });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –ø–∞–Ω–µ–ª–∏ (—Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–Ω–µ—Å—ë–Ω–Ω—ã–µ —Ç–µ–∑–∏—Å—ã)
async function loadCenter() {
  const { data } = await sb.from('theses')
    .select('*')
    .eq('is_central', true)
    .order('score', { ascending: false });

  const container = document.getElementById('center-content');
  container.innerHTML = '';

  data.forEach(item => {
    const totalVotes = (item.count_minus2 || 0) + (item.count_minus1 || 0) + (item.count_zero || 0) + (item.count_plus1 || 0) + (item.count_plus2 || 0);
    const fontSize = 1.1 + (totalVotes * 0.05) + 'rem';
    const fontWeight = 400 + (totalVotes * 40);

    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.thesisId = item.id;
    card.style.background = getColorByScore(item.score || 0);
    card.innerHTML = `
      <div class="text" style="font-size: ${fontSize}; font-weight: ${fontWeight};">${item.text}</div>
      <div class="reactions" data-thesis-id="${item.id}">
        ${reactions.map(r => `
          <div class="reaction-btn" data-value="${r.value}" onclick="vote('${item.id}', ${r.value})">
            <span class="emoji">${r.emoji}</span>
            <span class="count">${item[r.countField] || 0}</span>
          </div>
        `).join('')}
      </div>
    `;
    container.appendChild(card);
  });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–∏—Ö —Ç–µ–∑–∏—Å–æ–≤ (–ø—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å ‚Äî —Ç–æ–ª—å–∫–æ –º–æ–∏)
async function loadMyTheses() {
  const sort = localStorage.getItem('right_sort') || 'created_at_desc';

  const { data: sortOpt } = await sb.from('sort_options').select('order_by, order_dir').eq('sort_key', sort).single();
  const orderBy = sortOpt ? sortOpt.order_by : 'created_at';
  const orderDir = sortOpt ? sortOpt.order_dir : 'desc';

  const { data, error } = await sb.from('theses')
    .select('*')
    .eq('user_token', userToken)
    .order(orderBy, { ascending: orderDir === 'asc' });

  const container = document.getElementById('my-theses');
  if (!container) return console.error("–≠–ª–µ–º–µ–Ω—Ç my-theses –Ω–µ –Ω–∞–π–¥–µ–Ω");
  if (error) return console.error("–û—à–∏–±–∫–∞ –º–æ–∏—Ö —Ç–µ–∑–∏—Å–æ–≤:", error);

  container.innerHTML = '';

  data.forEach(item => {
    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.thesisId = item.id;
    card.style.background = getColorByScore(item.score || 0);
    card.innerHTML = `
      <div class="text">${item.text}</div>
      <div class="reactions" data-thesis-id="${item.id}">
        ${reactions.map(r => `
          <div class="reaction-btn" data-value="${r.value}" onclick="vote('${item.id}', ${r.value})">
            <span class="emoji">${r.emoji}</span>
            <span class="count">${item[r.countField] || 0}</span>
          </div>
        `).join('')}
      </div>
    `;
    container.appendChild(card);
  });
}

// –¶–≤–µ—Ç –ø–æ score
function getColorByScore(score) {
  if (score <= -1.5) return reactions[0].color;
  if (score <= -0.5) return reactions[1].color;
  if (score < 0.5) return reactions[2].color;
  if (score < 1.5) return reactions[3].color;
  return reactions[4].color;
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
document.getElementById('left-sort').addEventListener('change', (e) => {
  localStorage.setItem('left_sort', e.target.value);
  loadAllTheses();
});

document.getElementById('right-sort').addEventListener('change', (e) => {
  localStorage.setItem('right_sort', e.target.value);
  loadMyTheses();
});

// Live-–ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ votes
sb.channel('votes-live')
  .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'votes' }, (payload) => {
    loadAllTheses();
    loadMyTheses();
    loadCenter();
  })
  .subscribe();

// –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã sort_options
async function loadSortOptions() {
  const { data, error } = await sb.from('sort_options').select('*').order('id');
  if (error) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–æ–∫:", error);
    return;
  }

  const leftSelect = document.getElementById('left-sort');
  const rightSelect = document.getElementById('right-sort');
  leftSelect.innerHTML = '';
  rightSelect.innerHTML = '';

  data.forEach(opt => {
    const option = document.createElement('option');
    option.value = opt.sort_key;
    option.textContent = opt.display_name;
    option.title = opt.description || '';

    leftSelect.appendChild(option.cloneNode(true));
    rightSelect.appendChild(option);
  });

  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
  const leftSort = localStorage.getItem('left_sort') || 'created_at_desc';
  const rightSort = localStorage.getItem('right_sort') || 'created_at_desc';
  leftSelect.value = leftSort;
  rightSelect.value = rightSort;
}

// –ó–∞–ø—É—Å–∫
loadThreshold().then(() => {
  loadSortOptions().then(() => {
    loadAllTheses();
    loadMyTheses();
    loadCenter();
  });
});
document.getElementById('status').innerText = 'Realtime –ø–æ–¥–∫–ª—é—á—ë–Ω!';
document.getElementById('status').style.background = '#28a745';
</script>
</body>
</html>